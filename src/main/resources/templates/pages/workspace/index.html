<!DOCTYPE html>
<html lang="pt-br" th:replace="~{layout/dashboard/principal :: layout (~{:: content}, 'Área de trabalho')}">

<body>
    <content>
        <div class="content">

            <!-- Start Content-->
            <div class="container-fluid">

                <div class="row align-items-center mb-7">
                    <div class="col-auto">
                        <!-- Avatar -->
                        <div class="avatar avatar-xl rounded text-primary">
                            <i class="bi bi-tools"></i>
                        </div>
                    </div>
                    <div class="col">

                        <!-- Heading -->
                        <h1 class="fs-4 mb-0">Área de Trabalho</h1>
                    </div>
                </div>

                <search th:replace="~{layout/search-protocol}"></search>

                <div class="row">
                    <div class="col-xxl-12">

                        <open-requests class="mt-3 mb-3">
                            <h5 class="mt-6 pb-2">
                                <a data-bs-toggle="collapse" href="#open-requests" role="button" aria-expanded="true"
                                    aria-controls="open-requests">
                                    <i class="bi bi-envelope-arrow-down me-3"></i>Em aberto <span
                                        id="open-requests-length">([[${requests_OPEN}]])</span>
                                </a>
                            </h5>
                            <div class="collapse" th:classappend="${requests_OPEN > 0 ? 'show' : ''}" id="open-requests"
                                data-status="OPEN">
                                <div class="card shadow mb-0">
                                    <div class="card-body" id="open-requests-body"></div>
                                </div>
                            </div>
                        </open-requests>

                        <under-analysis-requests class="mt-3">
                            <h5 class="mt-6 pb-2">
                                <a data-bs-toggle="collapse" href="#under-analysis-requests" role="button"
                                    aria-expanded="true" aria-controls="under-analysis">
                                    <i class="bi bi-graph-down me-3"></i>Em análise <span class="text-muted"
                                        id="under_analysis-requests-length">([[${requests_UNDER_ANALYSIS}]])</span>
                                </a>
                            </h5>
                            <div class="collapse" id="under-analysis-requests" data-status="UNDER_ANALYSIS">
                                <div class="card mb-0">
                                    <div class="card-body" id="under_analysis-requests-body"></div>
                                </div>
                            </div>
                        </under-analysis-requests>

                        <answered-requests class="mt-3">
                            <h5 class="mt-6 pb-2">
                                <a data-bs-toggle="collapse" href="#answered-requests" role="button"
                                    aria-expanded="true" aria-controls="answered-requests">
                                    <i class="bi bi-envelope-arrow-up me-3"></i>Respondido <span class="text-muted"
                                        id="answered-requests-length">([[${requests_ANSWERED}]])</span>
                                </a>
                            </h5>
                            <div class="collapse" id="answered-requests" data-status="ANSWERED">
                                <div class="card mb-0">
                                    <div class="card-body" id="answered-requests-body">
                                        <!-- Tasks for ANSWERED -->
                                    </div>
                                </div>
                            </div>
                        </answered-requests>

                        <appeal-requests class="mt-3">
                            <h5 class="mt-6 pb-2">
                                <a data-bs-toggle="collapse" href="#appeal-requests" role="button" aria-expanded="true"
                                    aria-controls="appealTasks">
                                    <i class="bi bi-envelope-exclamation me-3"></i>Em recurso <span class="text-muted"
                                        id="appeal-requests-length">([[${requests_APPEAL}]])</span>
                                </a>
                            </h5>
                            <div class="collapse" id="appeal-requests" data-status="APPEAL">
                                <div class="card mb-0">
                                    <div class="card-body" id="appeal-requests-body"></div>
                                </div>
                            </div>
                        </appeal-requests>

                        <closed-requests class="mt-3">
                            <h5 class="mt-6 pb-2">
                                <a data-bs-toggle="collapse" href="#closed-requests" role="button" aria-expanded="true"
                                    aria-controls="closedTasks">
                                    <i class="bi bi-envelope-check me-3"></i>Finalizado <span class="text-muted"
                                        id="closed-requests-length">([[${requests_CLOSED}]])</span>
                                </a>
                            </h5>
                            <div class="collapse" id="closed-requests" data-status="CLOSED">
                                <div class="card mb-0">
                                    <div class="card-body" id="closed-requests-body"></div>
                                </div>
                            </div>
                        </closed-requests>
                    </div>
                </div>
            </div>

        </div>

        <script>

            let accordions = document.querySelectorAll('.collapse');

            accordions.forEach(accordion => {
                accordion.addEventListener('show.bs.collapse', async function (event) {
                    const accordionId = event.target.id;
                    const status = event.target.dataset.status;

                    showLoading();

                    const requests = await getRequestsByStatusAndDepartment(status, '[[${department}]]');

                    if (requests.length === 0) {
                        closeLoading();
                        return;
                    }

                    createToDoList(status.toLowerCase(), requests);

                });
            });

            window.onload = async () => {
                const openRequests = await getRequestsByStatusAndDepartment("OPEN", '[[${department}]]');
                createToDoList("open", openRequests);
            }

            const getRequestsByStatusAndDepartment = async (status, department) => {

                const response = await fetch(`/api/requests?status=${status}&department=${department}`);

                if (!response.ok) {
                    alert("Erro ao solicitar demandas")
                }

                const requests = await response.json();

                return requests;
            }

            const createToDoList = (status, requestList) => {
                let body = document.getElementById(`${status}-requests-body`);

                document.getElementById(`${status}-requests-length`).innerHTML = `(${requestList.length})`;

                if(requestList.length === 0) {
                    body.innerHTML = "Não há dados"
                    return;
                }

                let tableStructure = `
                        <table class="table table-striped table-hover table-borderless" id="tbl-${status}">
                            <thead class="text-center">
                                <tr>
                                    <th>###</th>
                                    <th>Descrição</th>
                                    <th>Solicitante</th>
                                    <th>Data de Solicitação</th>
                                    <th>Anexos</th>
                                </tr>
                            </thead>
                            <tbody id="${status}-requests-table-body">
                            </tbody>
                        </table>`;

                // Adiciona a estrutura da tabela dentro do body
                body.innerHTML = tableStructure;
                let tableBody = document.getElementById(`${status}-requests-table-body`);

                requestList.forEach(request => {
                    let newRow = `
                        <tr role="button">
                            <td>${request.id}</td>
                            <td>
                                <a href="/solicitacoes/${request.id}" 
                                    role="button" data-bs-toggle="tooltip" 
                                    data-bs-html="true"
                                    data-bs-placement="right" 
                                    data-bs-title="${request.description} ${request.requestType.title}">
                                    ${request.description}
                                </a>
                            </td>
                            <td>
                                <img src="assets/img/icons/avatar-default-symbolic-svgrepo-com.svg" 
                                    width="20" class="rounded-circle me-1" 
                                    alt="Avatar">
                                ${request.requester === null ? 'Anônimo' : request.requester?.username}
                            </td>
                            <td>
                                <i class="bi bi-calendar-event me-1"></i> ${new Date(request.createdAt).toLocaleString('pt-br')}
                            </td>
                            <td>
                                <i class="bi bi-paperclip"></i> ${request.attachments.length}
                            </td>
                        </tr>`;

                    tableBody.innerHTML += newRow;
                });

                // Ativar tooltips do Bootstrap
                var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                    return new bootstrap.Tooltip(tooltipTriggerEl);
                });

                closeLoading();

                new DataTable("#tbl-" + status, {
                    responsive: true,
                    language: {
                        url: "https://cdn.datatables.net/plug-ins/1.11.3/i18n/pt_br.json"
                    },
                })
            };

        </script>

    </content>
</body>

</html>